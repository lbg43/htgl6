<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器人后台管理系统</title>
    <style>
        /* 基础样式 */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
        }

        /* 左侧菜单 */
        .sidebar {
            width: 200px;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            background-color: #2d3436;
            color: white;
            padding-top: 20px;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            color: #b2bec3;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .menu-item.active {
            background-color: #636e72;
            color: white;
        }

        /* 主内容区 */
        .main-content {
            margin-left: 200px;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }

        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        /* 按钮样式 */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        /* 添加禁用按钮样式 */
        .btn.disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }

        .btn-logout {
            background-color: #f39c12;
            color: white;
            margin-top: 20px;
        }

        /* 调试信息 */
        #debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        /* 会话计时器 */
        /* 删除这段样式 */
        /* #session-timer {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        } */

        /* 模板编辑弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            width: 70%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        .modal-close:hover {
            color: #555;
        }

        .template-input {
            width: 100%;
            min-height: 300px;
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            box-sizing: border-box;
            display: block;
            text-align: left;
            overflow-y: auto;
            white-space: pre-wrap;
            text-indent: 0;
            word-break: break-word;
            background-color: #fff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div style="padding: 15px 20px; border-bottom: 1px solid #636e72;">
            <h3 style="margin: 0;">机器人后台管理系统</h3>
        </div>
        <a href="#" class="menu-item active" onclick="showTab('robots')">
            🤖 机器人列表
        </a>
        <a href="#" class="menu-item" onclick="showTab('users')">
            👥 用户管理
        </a>
        <a href="#" class="menu-item" onclick="showPasswordModal()">
            🔑 修改密码
        </a>
        <a href="#" class="menu-item" onclick="showTab('settings')">
            ⚙️ 系统设置
        </a>
        <a href="#" class="menu-item btn-logout" onclick="logout()">
            🚪 退出登录
        </a>
    </div>

    <!-- 添加管理员信息显示在右上角 -->
    <div id="admin-info" style="position: fixed; top: 10px; right: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 4px; font-size: 14px; z-index: 1000; display: flex; align-items: center;">
        <span style="margin-right: 8px;">👤</span>
        <span id="admin-username">管理员</span>
    </div>

    <div class="main-content">
        <!-- 机器人管理页面 -->
        <div id="robots-tab">
            <h2>机器人管理</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addRobot()">加机器人</button>
                <button class="btn btn-primary" onclick="batchAddRobots()">批量新增机器人</button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>机器人用户名</th>
                        <th>机器人token</th>
                        <th>管理员ID</th>
                        <th>欢迎语</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="robots-list"></tbody>
            </table>
        </div>

<!-- 用户管理页面 -->
<div id="users-tab" style="display: none;">
    <h2>用户管理</h2>
    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="refreshData('users')">刷新列表</button>
        <!-- 确保搜索框的value属性为空字符串 -->
        <input type="text" id="user-search-input" placeholder="输入关键词搜索用户" autocomplete="off" style="padding: 6px; margin-left: 10px; width: 200px;" value="">
        <button class="btn btn-primary" onclick="searchUsers()">搜索</button>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>用户ID</th>
                <th>用户名</th>
                <th>用户昵称</th>
                <th>注册时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="users-list"></tbody>
    </table>
    <!-- 分页控件 -->
    <div class="pagination" style="margin-top: 20px; text-align: center;">
        <button class="btn btn-primary" onclick="changePage('prev')" id="prev-page">上一页</button>
        <span id="page-info" style="margin: 0 15px;">第 1 页</span>
        <button class="btn btn-primary" onclick="changePage('next')" id="next-page">下一页</button>
        <!-- 添加直接跳转到指定页的功能 -->
        <span style="margin-left: 20px;">
            <input type="number" id="goto-page-input" placeholder="页码" min="1" style="width: 60px; padding: 6px; vertical-align: middle;">
            <button class="btn btn-primary" onclick="gotoSpecificPage()" style="vertical-align: middle;">跳转</button>
        </span>
    </div>
</div>
        <!-- 在系统设置标签页中移除修改密码和Worker URL部分 -->
        <div id="settings-tab" style="display: none;">
            <h2>系统设置</h2>
            
            <!-- 移除了Worker URL和修改密码部分 -->
        
            <!-- 模板管理部分 -->
            <div style="margin-top: 30px;">
                <h3>模板管理</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>内容</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="templates-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 模板编辑弹窗 -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeTemplateModal()">&times;</span>
            <h3 style="margin-top: 0; margin-bottom: 20px; font-size: 20px; color: #333; text-align: center;">编辑模板</h3>
            <div style="padding: 0">
                <textarea id="template-content" class="template-input" placeholder="请在此输入模板内容..." style="padding-left: 20px;"></textarea>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" style="margin-right: 20px; background-color: #f0f0f0; color: #333; padding: 10px 25px; font-size: 14px; border-radius: 4px;" onclick="closeTemplateModal()">取消</button>
                <button class="btn btn-primary" style="padding: 10px 25px; font-size: 14px; border-radius: 4px;" onclick="saveTemplate()">保存模板</button>
            </div>
        </div>
    </div>

    <!-- 添加修改密码的模态窗口 -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePasswordModal()">&times;</span>
            <h3>修改密码</h3>
            <div style="margin-top: 20px;">
                <label for="old-password-modal">旧密码:</label><br>
                <input type="password" id="old-password-modal" style="width: 100%; padding: 5px; margin: 5px 0;">
                
                <label for="new-password-modal">新密码:</label><br>
                <input type="password" id="new-password-modal" style="width: 100%; padding: 5px; margin: 5px 0;">
                
                <label for="confirm-password-modal">确认新密码:</label><br>
                <input type="password" id="confirm-password-modal" style="width: 100%; padding: 5px; margin: 5px 0;">
                
                <button class="btn btn-primary" onclick="changePasswordModal()" style="margin-top: 10px;">确认修改</button>
            </div>
        </div>
    </div>

    <!-- 保持原有的 HTML 结构不变，直到 debug-info div -->
        <div id="debug-info"></div>
    
        <!-- 合并所有的 script 到一个标签中 -->
        <script>
        // 修改CONFIG对象
        window.CONFIG = {
            API_KEY: 'api_key_123456',
            WORKER_URL: 'https://sweet-snow-00e0.vickippankeyz66.workers.dev',  // 修改为新的Cloudflare Worker URL
            VERSION: '2024-05-09-v2'  // 添加版本号，方便识别更新
        };
            let currentTemplateId = null;
            let currentTab = 'robots';
            let currentPage = 1;
            const pageSize = 10;
            let totalUsers = 0;
            let apiKey = '';  // 用于存储API密钥
            
            // 添加会话检查计时器
            let sessionCheckInterval = null;
    
            // 所有其他函数保持不变，但要删除重复定义的函数
            function log(message) {
                console.log(message);
                const debugInfo = document.getElementById('debug-info');
                const time = new Date().toLocaleTimeString();
                debugInfo.innerHTML = `<div>[${time}] ${message}</div>` + debugInfo.innerHTML;
                if (debugInfo.children.length > 10) {
                    debugInfo.removeChild(debugInfo.lastChild);
                }
            }
    
            // 添加一个函数在页面加载时显示版本信息
            function showVersion() {
                const versionElement = document.getElementById('version-info');
                if (versionElement) {
                    versionElement.textContent = CONFIG.VERSION || 'unknown';
                }
                // 在控制台也显示版本信息
                console.log("当前页面版本:", CONFIG.VERSION);
            }
    
            function startLoginCheck() {
                setInterval(checkLogin, 60 * 1000);
            }
    
            // 修改makeApiRequest函数
            async function makeApiRequest(data) {
                try {
                    // 获取存储的API密钥
                    const storedApiKey = localStorage.getItem('apiKey');
                    
                    console.log(`发送API请求到: ${CONFIG.WORKER_URL}/api`);
                    console.log('请求类型:', data.type);
                    console.log('请求数据:', data);
                    console.log('使用API密钥:', storedApiKey ? '已设置' : '未设置');
                    
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.WORKER_URL}/api`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-API-Key': storedApiKey || apiKey  // 添加API密钥头
                        },
                        mode: 'cors',  // 明确指定CORS模式
                        credentials: 'omit',  // 不发送cookies
                        body: JSON.stringify(data)
                    });
                    const endTime = Date.now();
                    
                    console.log(`API响应状态: ${response.status} ${response.statusText}, 耗时: ${endTime - startTime}ms`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('API响应数据:', responseData);
                    
                    if (responseData.error) {
                        throw new Error(responseData.error);
                    }
                    
                    return responseData;
                } catch (error) {
                    console.error(`API请求失败 (${data.type}):`, error);
                    log(`API请求失败: ${error.message}`);
                    throw error;
                }
            }

            // 修改testConnection函数
            async function testConnection() {
                try {
                    const storedApiKey = localStorage.getItem('apiKey');
                    
                    console.log('Testing connection to:', CONFIG.WORKER_URL);
                    
                    const response = await fetch(`${CONFIG.WORKER_URL}/test`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': storedApiKey || apiKey  // 添加API密钥头
                        }
                    });
                    
                    if (response.ok) {
                        console.log('Connection test successful');
                        const data = await response.json();
                        console.log('Response data:', data);
                        return true;
                    } else {
                        console.error('Connection test failed with status:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('Connection test failed:', error);
                    return false;
                }
            }
    
            // 页面加载时的初始化
            document.addEventListener('DOMContentLoaded', async () => {
                // 显示版本信息
                showVersion();
                
                // 检查用户是否已登录
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                const lastVerifyTime = localStorage.getItem('lastVerifyTime');
                const storedApiKey = localStorage.getItem('apiKey');
                const currentTime = Date.now();
                const sessionId = localStorage.getItem('sessionId');
                
                console.log("页面加载时检查登录状态:");
                console.log("- isLoggedIn:", isLoggedIn);
                console.log("- lastVerifyTime:", lastVerifyTime);
                console.log("- storedApiKey:", storedApiKey ? "已设置" : "未设置");
                console.log("- sessionId:", sessionId);
                
                if (isLoggedIn !== 'true' || !lastVerifyTime || !storedApiKey || currentTime - parseInt(lastVerifyTime) > 30 * 60 * 1000 || !sessionId) {
                    // 未登录或登录已过期，重定向到登录页面
                    log('登录已过期或无效，请重新登录');
                    window.location.href = 'index.html';
                    return;
                }
                
                // 设置API密钥
                apiKey = storedApiKey;
                console.log("设置当前apiKey变量:", apiKey);
                
                // 立即检查登录状态
                const loginValid = await checkLogin();
                if (!loginValid) {
                    return; // 登录无效，checkLogin函数已处理重定向
                }
                
                // 检查会话是否有效
                if (!checkSessionValid()) {
                    log('您的账号已在其他设备登录，请重新登录');
                    logout();
                    return;
                }
                
                // 启动会话检查定时器
                startSessionCheck();
                
                // 获取并显示管理员用户名
                try {
                    const adminUsername = localStorage.getItem('adminUsername') || 'admin';
                    document.getElementById('admin-username').textContent = adminUsername;
                } catch (error) {
                    console.error('获取管理员用户名失败:', error);
                }
                
                // 确保搜索框为空
                const searchInput = document.getElementById('user-search-input');
                if (searchInput) {
                    searchInput.value = '';
                    // 为搜索框添加回车键事件监听
                    searchInput.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            searchUsers();
                        }
                    });
                }

                // 为页码输入框添加回车键事件监听
                const gotoPageInput = document.getElementById('goto-page-input');
                if (gotoPageInput) {
                    gotoPageInput.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            gotoSpecificPage();
                        }
                    });
                }

                // 添加一个延迟清空搜索框的操作，确保在DOM完全加载后执行
                setTimeout(() => {
                    const searchInput = document.getElementById('user-search-input');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                }, 500);
                
                if (!CONFIG.WORKER_URL) {
                    log('请先配置 Worker URL');
                    showTab('settings');
                } else {
                    const isConnected = await testConnection();
                    if (isConnected) {
                        showTab('robots');
                        // startRealtimeUpdates(); // 不再自动刷新
                    } else {
                        log('无法连接到服务器，请检查配置');
                        showTab('settings');
                    }
                }
            });

    
            // 保持其他所有函数的实现不变...
            // showTab, refreshData, loadTemplates, editTemplate, 
            // closeTemplateModal, saveTemplate, loadRobots, loadUsers, 
            // changePage, updatePagination, startRealtimeUpdates 等函数
            function showTab(tab) {
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`.menu-item[onclick="showTab('${tab}')"]`).classList.add('active');
            
                document.getElementById('robots-tab').style.display = tab === 'robots' ? 'block' : 'none';
                document.getElementById('users-tab').style.display = tab === 'users' ? 'block' : 'none';
                document.getElementById('settings-tab').style.display = tab === 'settings' ? 'block' : 'none';
            
                // 当切换到用户标签页时，清空搜索框
                if (tab === 'users') {
                    document.getElementById('user-search-input').value = '';
                    // 清除搜索状态
                    window.currentSearchKeyword = null;
                    // 重置为第一页
                    currentPage = 1;
                }
            
                currentTab = tab;
                if (tab === 'settings') {
                    loadTemplates();
                } else {
                    refreshData(tab);
                }
            }
    
            async function refreshData(type) {
                if (type === 'robots') {
                    await loadRobots();
                } else if (type === 'users') {
                    await loadUsers();
                }
            }
    
            async function loadRobots() {
                try {
                    log('正在加载机器人列表...');
                    const result = await makeApiRequest({ type: 'getRobots' });
                    
                    if (!result.success) {
                        throw new Error(result.error || '加载失败');
                    }
                    
                    const tbody = document.getElementById('robots-list');
                    if (!result.robots || !Array.isArray(result.robots)) {
                        throw new Error('数据格式错误');
                    }
                    
                    tbody.innerHTML = result.robots.map(robot => `
                        <tr>
                            <td>${robot.username || '-'}</td>
                            <td>${robot.token || '-'}</td>
                            <td>${robot.adminId || '-'}</td>
                            <td>${robot.welcome || '-'}</td>
                            <td>
                                <button class="btn btn-primary robot-btn" data-action="editAdmin" data-robot-id="${robot.id}">管理员</button>
                                <button class="btn btn-primary robot-btn" data-action="editWelcome" data-robot-id="${robot.id}">欢迎语</button>
                                <button class="btn btn-primary robot-btn" data-action="viewUser" data-robot-id="${robot.id}">查看用户</button>
                            </td>
                        </tr>
                    `).join('');
                    log('机器人列表加载完成');
                    
                    // 添加调试信息
                    console.log('机器人列表已加载，当前机器人数量:', result.robots.length);
                    
                    // 为所有机器人按钮添加事件监听器
                    document.querySelectorAll('.robot-btn').forEach(button => {
                        button.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            
                            const action = this.getAttribute('data-action');
                            const robotId = this.getAttribute('data-robot-id');
                            
                            console.log(`点击了按钮: ${action}, 机器人ID: ${robotId}`);
                            log(`准备${action === 'editAdmin' ? '编辑管理员' : 
                                  action === 'editWelcome' ? '编辑欢迎语' : 
                                  '查看用户'}, 机器人ID: ${robotId}`);
                            
                            if (action === 'editAdmin') {
                                editAdmin(robotId);
                            } else if (action === 'editWelcome') {
                                editWelcome(robotId);
                            } else if (action === 'viewUser') {
                                viewUser(robotId);
                            }
                            
                            return false;
                        });
                    });
                } catch (error) {
                    if (error.message === 'Failed to fetch') {
                        log('无法连接到服务器，请检查：\n1. Worker 服务是否启动\n2. Worker URL 是否正确配置\n3. 网络连接是否正常');
                    } else {
                        log('加载失败: ' + error.message);
                    }
                    document.getElementById('robots-list').innerHTML = '<tr><td colspan="6">加载失败</td></tr>';
                }
            }
    
            // 修改后的 loadUsers 函数
            async function loadUsers(page) {
                if (!page) page = 1;
                currentPage = page;

                // 显示加载中提示
                document.getElementById('users-list').innerHTML = '<tr><td colspan="5" style="text-align: center;">加载中...</td></tr>';
                document.getElementById('page-info').textContent = `第 ${currentPage} 页`;

                try {
                    log(`加载用户列表: 页码=${page}, 每页数量=${pageSize}`);
                    const result = await makeApiRequest({
                        type: 'getUsers',
                        page: page,
                        pageSize: pageSize
                    });

                    if (result.success) {
                        log(`获取用户成功: 共${result.total}条记录, 当前第${result.page || currentPage}/${Math.ceil(result.total / pageSize)}页`);
                        // 渲染用户列表
                        const tbody = document.getElementById('users-list');
                        tbody.innerHTML = result.users.map(user => `
                            <tr data-user-id="${user.id}">
                                <td>${user.id || '-'}</td>
                                <td>${user.username || '-'}</td>
                                <td>${user.nickname || '-'}</td>
                                <td>${user.registerTime || '-'}</td>
                                <td>
                                    ${user.isBlocked 
                                        ? `<button class="btn btn-success" onclick="return unblockUser('${user.id}', event)">解封</button>` 
                                        : `<button class="btn btn-danger" onclick="return blockUser('${user.id}', event)">封禁</button>`}
                                </td>
                            </tr>
                        `).join('');

                        // 更新分页信息
                        totalUsers = result.total || result.users.length;
                        const totalPages = Math.ceil(totalUsers / pageSize) || 1;
                        document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;

                        // 更新分页按钮状态
                        document.getElementById('prev-page').disabled = currentPage <= 1;
                        document.getElementById('next-page').disabled = currentPage >= totalPages;
                    } else {
                        document.getElementById('users-list').innerHTML = 
                            `<tr><td colspan="5" style="text-align: center;">加载失败: ${result.error || '未知错误'}</td></tr>`;
                    }
                } catch (error) {
                    log('加载用户列表失败: ' + error.message);
                    document.getElementById('users-list').innerHTML = 
                        `<tr><td colspan="5" style="text-align: center;">加载失败: ${error.message}</td></tr>`;
                }
            }
    
            // 显示修改密码模态窗口
            function showPasswordModal() {
                document.getElementById('password-modal').style.display = 'block';
                // 清空输入框
                document.getElementById('old-password-modal').value = '';
                document.getElementById('new-password-modal').value = '';
                document.getElementById('confirm-password-modal').value = '';
            }
            
            // 关闭修改密码模态窗口
            function closePasswordModal() {
                document.getElementById('password-modal').style.display = 'none';
            }
            
            // 修改密码（模态窗口版本）
            async function changePasswordModal() {
                try {
                    const oldPassword = document.getElementById('old-password-modal').value;
                    const newPassword = document.getElementById('new-password-modal').value;
                    const confirmPassword = document.getElementById('confirm-password-modal').value;
                    
                    if (!oldPassword || !newPassword || !confirmPassword) {
                        log('请填写所有密码字段');
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        log('新密码和确认密码不一致');
                        return;
                    }
                    
                    // 尝试从服务器获取密码
                    try {
                        const passwordResponse = await fetch(`${CONFIG.WORKER_URL}/api`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': localStorage.getItem('apiKey') || ''
                            },
                            body: JSON.stringify({
                                type: 'getPassword'
                            })
                        });
                        
                        if (passwordResponse.ok) {
                            const passwordResult = await passwordResponse.json();
                            if (passwordResult.success && passwordResult.password) {
                                // 使用服务器密码验证
                                if (oldPassword !== passwordResult.password) {
                                    log('旧密码不正确');
                                    return;
                                }
                                console.log("使用服务器密码验证成功");
                            } else {
                                // 获取密码失败，使用本地密码
                                const currentPassword = localStorage.getItem('currentPassword') || 'admin123';
                                if (oldPassword !== currentPassword) {
                                    log('旧密码不正确');
                                    return;
                                }
                                console.log("使用本地密码验证成功");
                            }
                        } else {
                            // API请求失败，使用本地密码
                            const currentPassword = localStorage.getItem('currentPassword') || 'admin123';
                            if (oldPassword !== currentPassword) {
                                log('旧密码不正确');
                                return;
                            }
                            console.log("API请求失败，使用本地密码验证成功");
                        }
                    } catch (error) {
                        // 出错时使用本地密码
                        console.error('获取密码失败:', error);
                        const currentPassword = localStorage.getItem('currentPassword') || 'admin123';
                        if (oldPassword !== currentPassword) {
                            log('旧密码不正确');
                            return;
                        }
                    }
                    
                    log('正在修改密码...');
                    const result = await makeApiRequest({
                        type: 'changePassword',
                        oldPassword,
                        newPassword
                    });
                    
                    if (result.success) {
                        // 将新密码保存到 localStorage
                        localStorage.setItem('currentPassword', newPassword);
                        
                        // 显示更详细的成功信息
                        if (result.passwordSaved) {
                            log('密码已成功修改并保存到服务器，所有设备都需要使用新密码登录');
                            alert('密码已成功修改为: ' + newPassword + '\n新密码已保存到服务器，所有设备都需要使用新密码登录。\n请记住您的新密码！');
                        } else if (result.warning) {
                            log('密码已修改，但' + result.warning);
                            alert('密码已成功修改为: ' + newPassword + '\n但' + result.warning + '\n请记住您的新密码！');
                        } else {
                            log('密码修改成功，请使用新密码下次登录');
                            alert('密码已成功修改为: ' + newPassword + '\n请记住您的新密码，下次登录需要使用它。');
                        }
                        
                        closePasswordModal();
                        
                        // 3秒后退出登录
                        setTimeout(() => {
                            logout();
                        }, 3000);
                    } else {
                        log('密码修改失败: ' + (result.error || '未知错误'));
                    }
                } catch (error) {
                    log('密码修改请求失败: ' + error.message);
                }
            }
            
            // 封禁用户 - 防止跳转的改进版本
            async function blockUser(userId, event) {
                try {
                    // 先阻止默认事件
                    if (event) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    if (confirm("确定要封禁该用户吗？")) {
                        log('正在封禁用户...');
                        
                        const result = await makeApiRequest({
                            type: 'blockUser',
                            userId
                        });
                        if (result.success) {
                            log('用户已封禁');
                            
                            // 直接更新当前行的UI，而不是重新加载整个列表
                            const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                            if (userRow) {
                                const actionCell = userRow.querySelector('td:last-child');
                                if (actionCell) {
                                    actionCell.innerHTML = `<button class="btn btn-success" onclick="return unblockUser('${userId}', event)">解封</button>`;
                                }
                                return false; // 阻止默认行为
                            } else {
                                // 如果找不到行元素，使用更保守的方式更新
                                // 不使用await，避免阻塞和可能的跳转
                                setTimeout(() => {
                                    if (window.currentSearchKeyword) {
                                        searchUsersPage(window.currentSearchKeyword, currentPage);
                                    } else {
                                        loadUsers();
                                    }
                                }, 100);
                            }
                        }
                    }
                    return false; // 阻止默认行为
                } catch (error) {
                    log('封禁用户失败: ' + error.message);
                    return false; // 即使出错也阻止默认行为
                }
            }
    
            // 解封用户 - 防止跳转的改进版本
            async function unblockUser(userId, event) {
                try {
                    // 先阻止默认事件
                    if (event) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    if (confirm("确定要解封该用户吗？")) {
                        log('正在解封用户...');
                        
                        const result = await makeApiRequest({
                            type: 'unblockUser',
                            userId
                        });
                        if (result.success) {
                            log('用户已解封');
                            
                            // 直接更新当前行的UI，而不是重新加载整个列表
                            const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
                            if (userRow) {
                                const actionCell = userRow.querySelector('td:last-child');
                                if (actionCell) {
                                    actionCell.innerHTML = `<button class="btn btn-danger" onclick="return blockUser('${userId}', event)">封禁</button>`;
                                }
                                return false; // 阻止默认行为
                            } else {
                                // 如果找不到行元素，使用更保守的方式更新
                                // 不使用await，避免阻塞和可能的跳转
                                setTimeout(() => {
                                    if (window.currentSearchKeyword) {
                                        searchUsersPage(window.currentSearchKeyword, currentPage);
                                    } else {
                                        loadUsers();
                                    }
                                }, 100);
                            }
                        }
                    }
                    return false; // 阻止默认行为
                } catch (error) {
                    log('解封用户失败: ' + error.message);
                    return false; // 即使出错也阻止默认行为
                }
            }
    
            // 编辑管理员
            async function editAdmin(robotId) {
                try {
                    console.log('准备编辑管理员，robotId:', robotId);
                    log('打开管理员ID编辑对话框');
                    
                    const adminId = prompt("请输入新的管理员ID:");
                    console.log('用户输入的管理员ID:', adminId);
                    
                    if (!adminId) {
                        log('已取消编辑管理员');
                        return;
                    }
                    
                    log('正在更新管理员ID...');
                    const result = await makeApiRequest({
                        type: 'editAdmin',
                        robotId,
                        adminId
                    });
                    
                    console.log('服务器响应:', result);
                    
                    if (result && result.success) {
                        log('管理员已更新为: ' + adminId);
                        await loadRobots();
                    } else {
                        throw new Error(result?.error || '未知错误');
                    }
                } catch (error) {
                    console.error('编辑管理员出错:', error);
                    log('更新管理员失败: ' + error.message);
                    alert('更新管理员失败: ' + error.message);
                }
            }
    
            // 编辑欢迎语
            async function editWelcome(robotId) {
                try {
                    console.log('准备编辑欢迎语，robotId:', robotId);
                    log('打开欢迎语编辑对话框');
                    
                    const welcome = prompt("请输入新的欢迎语:");
                    console.log('用户输入的欢迎语:', welcome);
                    
                    if (welcome === null) {
                        log('已取消编辑欢迎语');
                        return;
                    }
                    
                    log('正在更新欢迎语...');
                    const result = await makeApiRequest({
                        type: 'editWelcome',
                        robotId,
                        welcome
                    });
                    
                    console.log('服务器响应:', result);
                    
                    if (result && result.success) {
                        log('欢迎语已更新');
                        await loadRobots();
                    } else {
                        throw new Error(result?.error || '未知错误');
                    }
                } catch (error) {
                    console.error('编辑欢迎语出错:', error);
                    log('更新欢迎语失败: ' + error.message);
                    alert('更新欢迎语失败: ' + error.message);
                }
            }
    
            // 查看用户
            function viewUser(robotId) {
                showTab('users');
            }
    
            // 加载模板
            async function loadTemplates() {
                try {
                    log('正在加载模板列表...');
                    const result = await makeApiRequest({ type: 'getTemplates' });
                    
                    if (!result || !result.success || !result.templates) {
                        throw new Error('加载模板失败，返回数据格式错误');
                    }
                    
                    const tbody = document.getElementById('templates-list');
                    tbody.innerHTML = result.templates.map(template => `
                        <tr>
                            <td>${template.id}</td>
                            <td>${template.name}</td>
                            <td>${template.content.substring(0, 30)}...</td>
                            <td>
                                <button class="btn btn-primary" onclick="editTemplate('${template.id}')">编辑</button>
                            </tr>
                        `).join('');
                    
                    log(`模板列表加载完成，共 ${result.templates.length} 个模板`);
                } catch (error) {
                    console.error('加载模板失败:', error);
                    log('加载模板失败: ' + error.message);
                    document.getElementById('templates-list').innerHTML = '<tr><td colspan="4">加载失败</td></tr>';
                }
            }
    
            // 编辑模板
            async function editTemplate(templateId) {
                try {
                    log(`正在获取模板 ${templateId} 内容...`);
                    currentTemplateId = templateId;
                    const result = await makeApiRequest({ 
                        type: 'getTemplate', 
                        templateId: templateId 
                    });
                    
                    if (!result || !result.success) {
                        throw new Error(result?.error || '获取模板失败');
                    }
                    
                    document.getElementById('template-content').value = result.content;
                    document.getElementById('template-modal').style.display = 'block';
                    log(`模板 ${templateId} 内容加载完成`);
                } catch (error) {
                    console.error('获取模板失败:', error);
                    log('获取模板失败: ' + error.message);
                }
            }
    
            // 关闭模板编辑弹窗
            function closeTemplateModal() {
                document.getElementById('template-modal').style.display = 'none';
            }
    
            // 保存模板
            async function saveTemplate() {
                try {
                    const content = document.getElementById('template-content').value;
                    
                    // 先获取当前API密钥，确保它存在
                    const storedApiKey = localStorage.getItem('apiKey');
                    if (!storedApiKey) {
                        log('缺少API密钥，请刷新页面重新登录');
                        return;
                    }
                    
                    log('正在保存模板...');
                    
                    // 先检查登录状态
                    const loginValid = await checkLogin();
                    if (!loginValid) {
                        log('登录状态已失效，无法保存模板');
                        return;
                    }
                    
                    // 使用API路由替代直接访问endpoint
                    const response = await makeApiRequest({
                        type: 'updateTemplate',
                        templateId: currentTemplateId,
                        content: content
                    });
                    
                    if (response.success) {
                        log('模板已成功保存');
                        closeTemplateModal();
                        loadTemplates();
                    } else {
                        log('保存模板失败: ' + (response.error || '未知错误'));
                    }
                } catch (error) {
                    log('保存模板失败: ' + error.message);
                }
            }
    
            // 保存设置
            function saveSettings() {
                // 由于没有worker-url元素，我们可以直接使用CONFIG.WORKER_URL
                log('设置已保存');
                testConnection();
            }
    
            // 加载当前页数据
            function loadCurrentPage() {
                // 根据是否有搜索关键词决定加载方式
                if (window.currentSearchKeyword) {
                    // 搜索结果分页
                    searchUsersPage(window.currentSearchKeyword, currentPage);
                } else {
                    // 普通用户列表
                    loadUsers();
                }
                log(`正在加载第 ${currentPage} 页数据...`);
            }
            
            // 清除搜索状态
            function clearSearchState() {
                window.currentSearchKeyword = null;
                const searchInput = document.getElementById('user-search-input');
                if (searchInput) {
                    searchInput.value = '';
                }
                log('已清除搜索状态');
            }
            
            // 修改changePage函数，使其和gotoPage保持一致的行为
            function changePage(direction) {
                const totalPages = Math.ceil(totalUsers / pageSize) || 1;
                if (direction === 'prev' && currentPage > 1) {
                    currentPage--;
                } else if (direction === 'next' && currentPage < totalPages) {
                    currentPage++;
                } else {
                    return; // 已经是第一页或最后一页
                }
                document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
                // 判断是否有搜索关键词
                if (window.currentSearchKeyword) {
                    searchUsersPage(window.currentSearchKeyword, currentPage);
                } else {
                    loadUsers(currentPage);
                }
            }
            
            // 添加跳转到指定页的功能
            function gotoSpecificPage() {
                const inputPage = parseInt(document.getElementById('goto-page-input').value);
                const totalPages = Math.ceil(totalUsers / pageSize) || 1;
                
                // 验证页码是否有效
                if (isNaN(inputPage) || inputPage < 1 || inputPage > totalPages) {
                    alert(`请输入有效的页码(1-${totalPages})`);
                    return;
                }
                
                // 设置当前页码并更新页码显示
                currentPage = inputPage;
                document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
                
                // 清空输入框
                document.getElementById('goto-page-input').value = '';
                
                // 根据是否有搜索关键词决定加载方式
                if (window.currentSearchKeyword) {
                    searchUsersPage(window.currentSearchKeyword, currentPage);
                } else {
                    loadUsers(currentPage);
                }
            }
            
            // 搜索用户指定页
            async function searchUsersPage(keyword, page) {
                try {
                    if (!keyword || keyword.trim() === '') {
                        // 如果关键词为空，清除搜索状态，加载普通用户列表
                        window.currentSearchKeyword = null;
                        loadUsers();
                        return;
                    }
                    
                    log(`正在加载搜索结果第 ${page} 页...`);
                    const result = await makeApiRequest({
                        type: 'searchUsers',
                        keyword,
                        page: page,
                        pageSize: pageSize
                    });
                    
                    if (result.success && result.users) {
                        // 更新总用户数和分页信息
                        totalUsers = result.total || result.users.length;
                        
                        const tbody = document.getElementById('users-list');
                        if (result.users.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5">未找到匹配的用户</td></tr>';
                            log('未找到匹配的用户');
                            // 不要隐藏分页控件
                            updatePagination();
                        } else {
                            tbody.innerHTML = result.users.map(user => `
                                <tr data-user-id="${user.id}">
                                    <td>${user.id || '-'}</td>
                                    <td>${user.username || '-'}</td>
                                    <td>${user.nickname || '-'}</td>
                                    <td>${user.registerTime || '-'}</td>
                                    <td>
                                        ${user.isBlocked 
                                            ? `<button class="btn btn-success" onclick="return unblockUser('${user.id}', event)">解封</button>` 
                                            : `<button class="btn btn-danger" onclick="return blockUser('${user.id}', event)">封禁</button>`}
                                    </td>
                                </tr>
                            `).join('');
                            log(`搜索到 ${result.total} 个匹配用户，当前显示 ${result.users.length} 个`);
                            
                            // 显示分页控件
                            updatePagination();
                            
                            // 保存当前搜索关键词
                            window.currentSearchKeyword = keyword;
                        }
                    } else {
                        throw new Error(result.error || '搜索失败');
                    }
                } catch (error) {
                    log('加载搜索结果失败: ' + error.message);
                }
            }
            
            function updatePagination() {
                const prevButton = document.getElementById('prev-page');
                const nextButton = document.getElementById('next-page');
                const totalPages = Math.ceil(totalUsers / pageSize) || 1;

                prevButton.disabled = currentPage <= 1;
                nextButton.disabled = currentPage >= totalPages;

                document.getElementById('page-info').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;

                // 始终显示分页控件
                document.querySelector('.pagination').style.display = 'block';
            }
                
                               // 实时更新
                               function startRealtimeUpdates() {
                    setInterval(() => {
                        if (currentTab === 'robots') {
                            loadRobots();
                        } else if (currentTab === 'users') {
                            loadUsers();
                        }
                    }, 30000); // 每30秒刷新一次
                }
                
                // 检查登录状态
                async function checkLogin() {
                    try {
                        // 检查本地存储的登录状态
                        const isLoggedIn = localStorage.getItem('isLoggedIn');
                        const lastVerifyTime = localStorage.getItem('lastVerifyTime');
                        const storedApiKey = localStorage.getItem('apiKey');
                        const sessionId = localStorage.getItem('sessionId');
                        const currentTime = Date.now();
                        
                        // 如果本地存储显示未登录或者登录已过期，重定向到登录页面
                        if (isLoggedIn !== 'true' || !lastVerifyTime || !storedApiKey || !sessionId || currentTime - parseInt(lastVerifyTime) > 30 * 60 * 1000) {
                            console.log('登录状态无效或已过期');
                            log('登录已过期，请重新登录');
                            window.location.href = 'index.html';
                            return false;
                        }
                        
                        // 检查会话是否有效
                        if (!checkSessionValid()) {
                            log('您的账号已在其他设备登录，请重新登录');
                            logout();
                            return false;
                        }
                        
                        // 如果有API请求失败计数达到阈值，直接重定向
                        const apiFailCount = parseInt(sessionStorage.getItem('apiFailCount') || '0');
                        if (apiFailCount > 5) {
                            console.log('API请求失败次数过多，需要重新登录');
                            log('连接服务器失败，请重新登录');
                            logout();
                            return false;
                        }
                        
                        try {
                            // 尝试与服务器进行通信，验证登录状态
                            const response = await fetch(`${CONFIG.WORKER_URL}/getMe`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-API-Key': storedApiKey
                                }
                            });
                            
                            if (response.ok) {
                                // 如果通信成功，更新最后验证时间
                                localStorage.setItem('lastVerifyTime', currentTime.toString());
                                // 重置API失败计数
                                sessionStorage.setItem('apiFailCount', '0');
                                return true;
                            } else {
                                throw new Error(`服务器响应错误: ${response.status}`);
                            }
                        } catch (error) {
                            // 记录API请求失败次数
                            sessionStorage.setItem('apiFailCount', (apiFailCount + 1).toString());
                            console.error('验证登录状态失败:', error);
                            // 如果失败次数未超过阈值，暂时不重定向，允许继续操作
                            if (apiFailCount <= 4) {
                                log('警告: 与服务器通信失败，但您可以继续使用。');
                                return true;
                            } else {
                                log('无法连接服务器，请检查网络或重新登录');
                                return false;
                            }
                        }
                    } catch (error) {
                        console.error('检查登录状态出错:', error);
                        return false;
                    }
                }
                
                function logout() {
                    // 清除定时器
                    if (sessionCheckInterval) {
                        clearInterval(sessionCheckInterval);
                        sessionCheckInterval = null;
                    }
                    
                    localStorage.removeItem('lastVerifyTime');
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('apiKey');
                    localStorage.removeItem('sessionId');
                    window.location.href = 'index.html';
                }
                
                // 搜索用户
                async function searchUsers() {
                    try {
                        const keyword = document.getElementById('user-search-input').value.trim();
                        if (!keyword) {
                            log('请输入搜索关键词');
                            // 清除搜索状态
                            window.currentSearchKeyword = null;
                            // 加载普通用户列表
                            loadUsers();
                            return;
                        }
                        
                        // 搜索时重置为第一页
                        currentPage = 1;
                        
                        log(`正在搜索用户: ${keyword}...`);
                        const result = await makeApiRequest({
                            type: 'searchUsers',
                            keyword,
                            page: currentPage,
                            pageSize: pageSize
                        });
                        
                        if (result.success && result.users) {
                            // 更新总用户数和分页信息
                            totalUsers = result.total || result.users.length;
                            
                            const tbody = document.getElementById('users-list');
                            if (result.users.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="5">未找到匹配的用户</td></tr>';
                                log('未找到匹配的用户');
                                // 不要隐藏分页控件
                                updatePagination();
                            } else {
                                tbody.innerHTML = result.users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.id || '-'}</td>
                                        <td>${user.username || '-'}</td>
                                        <td>${user.nickname || '-'}</td>
                                        <td>${user.registerTime || '-'}</td>
                                        <td>
                                            ${user.isBlocked 
                                                ? `<button class="btn btn-success" onclick="return unblockUser('${user.id}', event)">解封</button>` 
                                                : `<button class="btn btn-danger" onclick="return blockUser('${user.id}', event)">封禁</button>`}
                                        </td>
                                    </tr>
                                `).join('');
                                log(`搜索到 ${result.total} 个匹配用户，当前显示 ${result.users.length} 个`);
                                
                                // 显示分页控件
                                updatePagination();
                                
                                // 保存当前搜索关键词
                                window.currentSearchKeyword = keyword;
                            }
                        } else {
                            throw new Error(result.error || '搜索失败');
                        }
                    } catch (error) {
                        log('搜索用户失败: ' + error.message);
                    }
                }
                
                // 添加机器人函数
                async function addRobot() {
                    try {
                        const username = prompt("请输入机器人用户名:");
                        if (!username) return;
                        
                        const token = prompt("请输入机器人Token:");
                        if (!token) return;
                        
                        const adminId = prompt("请输入管理员ID:");
                        if (!adminId) return;
                        
                        const welcome = prompt("请输入欢迎语(可选):", "欢迎使用Telegram官方机器人！如需解除异常请点击开始解除！");
                        
                        log(`正在添加机器人: ${username}`);
                        const result = await makeApiRequest({
                            type: 'addRobot',
                            username,
                            token,
                            adminId,
                            welcome,
                            isFirst: true // 假设这是第一个机器人
                        });
                        
                        if (result.success) {
                            log(result.message || '机器人添加成功');
                            await loadRobots(); // 重新加载机器人列表
                        }
                    } catch (error) {
                        log('添加机器人失败: ' + error.message);
                    }
                }
                
                // 批量添加机器人函数
                async function batchAddRobots() {
                    try {
                        const robotsText = prompt("请输入机器人信息，格式为：用户名,Token,管理员ID,欢迎语\n每行一个机器人，例如：\nbot1,token1,admin1,欢迎使用\nbot2,token2,admin2,欢迎使用");
                        if (!robotsText) return;
                        
                        const robotsLines = robotsText.split('\n');
                        const robots = [];
                        
                        for (const line of robotsLines) {
                            const parts = line.split(',');
                            if (parts.length >= 3) {
                                robots.push({
                                    username: parts[0].trim(),
                                    token: parts[1].trim(),
                                    adminId: parts[2].trim(),
                                    welcome: parts[3] ? parts[3].trim() : '欢迎使用Telegram官方机器人！如需解除异常请点击开始解除！'
                                });
                            }
                        }
                        
                        if (robots.length === 0) {
                            log('没有有效的机器人信息');
                            return;
                        }
                        
                        log(`正在批量添加 ${robots.length} 个机器人...`);
                        const result = await makeApiRequest({
                            type: 'batchAddRobots',
                            robots
                        });
                        
                        if (result.success) {
                            log(result.message || `成功添加 ${robots.length} 个机器人`);
                            await loadRobots(); // 重新加载机器人列表
                        }
                    } catch (error) {
                        log('批量添加机器人失败: ' + error.message);
                    }
                }
            
            // 检查会话是否有效
            async function checkSessionValid() {
                try {
                    const currentSessionId = localStorage.getItem('sessionId');
                    const username = localStorage.getItem('adminUsername');
                    
                    if (!currentSessionId || !username) {
                        console.log('会话检查失败: 本地存储中缺少会话ID或用户名');
                        return false;
                    }
                    
                    console.log(`正在检查会话有效性: sessionId=${currentSessionId}, username=${username}`);
                    
                    // 调用服务器API检查会话是否有效
                    const response = await fetch(`${CONFIG.WORKER_URL}/session/check`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sessionId: currentSessionId,
                            username: username
                        })
                    });
                    
                    if (!response.ok) {
                        console.error('会话检查请求失败:', response.status, response.statusText);
                        // 如果是服务器错误，我们认为会话有效，避免因服务器问题踢出用户
                        if (response.status >= 500) {
                            console.log('服务器错误，假定会话有效');
                            return true;
                        }
                        return false;
                    }
                    
                    const result = await response.json();
                    console.log('会话检查结果:', result);
                    
                    // 如果服务器返回警告信息，说明KV存储可能有问题
                    if (result.warning) {
                        console.warn('服务器警告:', result.warning);
                    }
                    
                    return result.isValid;
                } catch (error) {
                    console.error('检查会话有效性出错:', error);
                    // 网络错误或其他意外错误，我们认为会话有效，避免因网络问题踢出用户
                    console.log('发生错误，假定会话有效');
                    return true;
                }
            }
            
            // 启动会话检查定时器
            function startSessionCheck() {
                // 清除可能存在的旧定时器
                if (sessionCheckInterval) {
                    clearInterval(sessionCheckInterval);
                }
                
                // 记录连续失败次数
                let consecutiveFailures = 0;
                const MAX_FAILURES = 3; // 连续失败3次才登出
                
                // 每10秒检查一次会话状态
                sessionCheckInterval = setInterval(async () => {
                    try {
                        const isValid = await checkSessionValid();
                        
                        if (isValid) {
                            // 会话有效，重置失败计数
                            consecutiveFailures = 0;
                        } else {
                            // 会话无效，增加失败计数
                            consecutiveFailures++;
                            console.log(`会话检查失败 (${consecutiveFailures}/${MAX_FAILURES})`);
                            
                            // 只有连续失败达到阈值才登出
                            if (consecutiveFailures >= MAX_FAILURES) {
                                // 如果会话无效，显示提示并登出
                                alert('您的账号已在其他设备登录，将自动退出登录');
                                logout();
                            }
                        }
                    } catch (error) {
                        console.error('会话检查出错:', error);
                        // 出错时不增加失败计数，避免因网络问题导致误判
                    }
                }, 10000);
                
                // 页面关闭前清除定时器
                window.addEventListener('beforeunload', () => {
                    if (sessionCheckInterval) {
                        clearInterval(sessionCheckInterval);
                    }
                });
            }
             </script>
         </body>
         </html>